  name: "Deploy"
  run-name: "Deploy ${{ github.event.inputs.environment }}"

  on:
    workflow_dispatch:
      inputs:
        environment:
          description: "Environment to deploy to"
          required: true
          type: choice
          options:
            - dev
            - prod
        image:
          description: "Image reference to deploy (required for prod)"
          required: false
          type: string

  jobs:
    build:
      name: "build"
      if: github.event.inputs.environment == 'dev'
      runs-on: ubuntu-latest
      permissions:
        packages: write
        contents: read
        id-token: write
      steps:
        - uses: actions/checkout@v4
        - name: JDK
          uses: actions/setup-java@v5
          with:
            distribution: temurin
            java-version: '25'
            cache: maven
        - name: Build
          run: mvn clean package --batch-mode --settings ./.mvn/settings.xml
        - name: Login to GitHub Packages Docker Registry
          uses: docker/login-action@v3
          with:
            registry: ghcr.io
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}
        - name: Build and push
          id: docker-build-push
          uses: nais/docker-build-push@v0
          with:
            team: team-researchops
            identity_provider: ${{ secrets.NAIS_WORKLOAD_IDENTITY_PROVIDER }}
            project_id: ${{ vars.NAIS_MANAGEMENT_PROJECT_ID }}
            build_args: |
              JAR_PATH=target/app.jar
        - name: Show image for later prod deploy
          run: |
            echo "Built image: ${{ steps.docker-build-push.outputs.image }}"

      outputs:
        image: ${{ steps.docker-build-push.outputs.image }}

    deploy-dev:
      if: github.event.inputs.environment == 'dev'
      needs: build
      runs-on: ubuntu-latest
      permissions:
        contents: read
        id-token: write
      steps:
        - uses: actions/checkout@v4
        - name: Deploy to Dev
          uses: nais/deploy/actions/deploy@v2
          env:
            CLUSTER: dev-gcp
            RESOURCE: .nais/nais-dev.yaml
            VAR: image=${{ needs.build.outputs.image }},version=${{ github.sha }}

    deploy-prod:
      if: github.event.inputs.environment == 'prod'
      runs-on: ubuntu-latest
      permissions:
        contents: write
        id-token: write
      steps:
        - uses: actions/checkout@v4
        - name: Ensure image input is provided
          run: |
            if [ -z "${{ github.event.inputs.image }}" ]; then
              echo "Input 'image' is required for prod deploy."
              exit 1
            fi
        - name: Deploy to Prod
          uses: nais/deploy/actions/deploy@v2
          env:
            CLUSTER: prod-gcp
            RESOURCE: .nais/nais-prod.yaml
            VAR: image=${{ github.event.inputs.image }},version=${{ github.sha }}
        - name: Create deployment tag
          if: success()
          run: |
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            TAG_NAME="prod-$(date -u +'%Y.%m.%d-%H%M%S')"
            git tag -a "$TAG_NAME" -m "Production deployment of ${{ github.sha }}"
            git push origin "$TAG_NAME"